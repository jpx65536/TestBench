# ===== ProxySQL 3.0.2 for MySQL 8.0 : RW-Split (writer=10, reader=20) =====
datadir="/var/lib/proxysql"
version="3.0.2"

admin_variables = {
  admin_credentials = "admin:admin"
  web_enabled = true
  web_port = 6080
}

mysql_variables = {
  interfaces = "0.0.0.0:6033;/var/lib/proxysql/proxysql.sock"
  threads = 4
  max_connections = 4096

  # monitor（用你在主库上创建的 monitor 用户）
  monitor_username = "monitor"
  monitor_password = "monitor"
  monitor_history = 600000
  monitor_connect_interval = 2000
  monitor_ping_interval = 10000
  monitor_read_only_interval = 1000

  # 连接/超时
  default_query_timeout = 36000000
  connect_timeout_server = 3000

  # 事务识别（让事务开始后保持在 writer）
  autocommit_false_is_transaction = true
  persistent_transactions = true
}

# 后端实例。hostgroup_id：10=writer，20=readers
mysql_servers = (
  { address="master" ,  port=3306, hostgroup_id=10, max_connections=500, comment="writer"  },
  { address="replica1", port=3306, hostgroup_id=20, max_connections=500, max_replication_lag=10, comment="reader1" },
  { address="replica2", port=3306, hostgroup_id=20, max_connections=500, max_replication_lag=10, comment="reader2" }
)

# 告诉 ProxySQL 10与20互为主从组，按只读位判断主从、并在读节点延迟大时自动摘除
mysql_replication_hostgroups = (
  { writer_hostgroup=10, reader_hostgroup=20, check_type="READ_ONLY", comment="rw-split mysql8" }
)

# 应用与监控用户（应用只连 ProxySQL 即可）
mysql_users = (
  { username="appuser", password="app_pass", default_hostgroup=10, transaction_persistent=true, active=1 },
  { username="monitor", password="monitor", default_hostgroup=10, active=1 }
)

# 规则：
#  - DML/DDL 一律走写(10)
#  - 事务起始(BEGIN/START TRANSACTION)与提交(COMMIT/ROLLBACK)走写
#  - 普通 SELECT 走读(20)
#  - 带 /*force_writer*/ 的语句强制走写（需要强一致读时可用）
mysql_query_rules = (
  { rule_id=10, active=1, match_digest="^\\s*(BEGIN|START\\s+TRANSACTION)", destination_hostgroup=10, apply=1, flagOUT=1 },
  { rule_id=20, active=1, match_digest="^\\s*(INSERT|UPDATE|DELETE|REPLACE|CREATE|DROP|ALTER|TRUNCATE|RENAME)", destination_hostgroup=10, apply=1, flagOUT=1 },
  { rule_id=30, active=1, match_digest="^\\s*(COMMIT|ROLLBACK)", destination_hostgroup=10, apply=1 },
  { rule_id=40, active=1, match_digest="^\\s*SELECT", destination_hostgroup=20, apply=1 },
  { rule_id=50, active=1, match_digest="/\\*force_writer\\*/", destination_hostgroup=10, apply=1 }
)

